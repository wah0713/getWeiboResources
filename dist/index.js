// ==UserScript==
// @name         ÂæÆÂçö‰∏ÄÈîÆ‰∏ãËΩΩÔºà9ÂÆ´Ê†º&&ËßÜÈ¢ëÔºâ
// @namespace    https://github.com/wah0713/getWeiboResources
// @version      2.0.2
// @description  ‰∏Ä‰∏™ÂÖ¥Ë∂£‰ΩøÁÑ∂ÁöÑËÑöÊú¨ÔºåÂæÆÂçö‰∏ÄÈîÆ‰∏ãËΩΩËÑöÊú¨„ÄÇÂÇªÁìúÂºèüêµÔºàÁÆÄÂçïüçé„ÄÅÊòìÁî®üß©„ÄÅÂèØÈù†üí™Ôºâ
// @supportURL   https://github.com/wah0713/getWeiboResources/issues
// @updateURL    https://greasyfork.org/scripts/454816/code/download.user.js
// @author       wah0713
// @compatible   chrome
// @license      MIT
// @icon         https://weibo.com/favicon.ico
// @require      https://cdn.bootcss.com/jquery/1.12.4/jquery.min.js
// @require      https://cdn.bootcss.com/jszip/3.1.5/jszip.min.js
// @require      https://cdn.bootcdn.net/ajax/libs/m3u8-parser/6.0.0/m3u8-parser.min.js
// @match        *://weibo.com/*
// @match        *://*.weibo.com/*
// @match        *://t.cn/*
// @connect      sinaimg.cn
// @connect      weibo.com
// @connect      weibocdn.com
// @connect      miaopai.com
// @connect      qq.com
// @connect      youku.com
// @connect      weibo.com
// @connect      cibntv.net
// @connect      data.video.iqiyi.com
// @connect      cache.m.iqiyi.com
// @connect      *
// @noframes     true
// @run-at       document-idle
// @grant        GM_addStyle
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_registerMenuCommand
// @grant        GM_unregisterMenuCommand
// @grant        GM_xmlhttpRequest
// @grant        unsafeWindow
// ==/UserScript==

(async function () {
    const $frameContent = $('.Frame_content_3XrxZ')
    const $mMain = $('.m-main')
    let $main = ''
    let $cardList = ''
    let cardHeadStr = ''
    let cardHeadAStr = ''
    if ($frameContent.length === 0 && $mMain.length) {
        // ÊêúÁ¥¢È°µÈù¢
        $main = $mMain
        $cardList = $('.main-full')
        cardHeadStr = 'div.card-feed  div.from'
        cardHeadAStr = 'a[suda-data]'
    } else if ($frameContent.length && $mMain.length === 0) {
        // ÈªòËÆ§È°µÈù¢
        $main = $frameContent
        $cardList = $('.Main_full_1dfQX')
        cardHeadStr = '.head-info_info_2AspQ'
        cardHeadAStr = '.head-info_time_6sFQg'
    } else {
        return false
    }

    // Á¨¨‰∏ÄÊ¨°‰ΩøÁî®
    let isFirst = GM_getValue('isFirst', true)
    // ÊòØÂê¶ÂºÄÂêØdubugÊ®°Âºè
    let isDebug = false

    let timer = null
    // Ê∂àÊÅØ
    const message = {
        getReady: 'ÂáÜÂ§á‰∏≠',
        isEmptyError: 'Â§±Ë¥•ÔºåÊú™ÊâæÂà∞ËµÑÊ∫ê',
        // todo ËØ¥‰∏çÂÆö‰ª•ÂêéÊÉ≥ÂÅöÁõ¥Êí≠ËµÑÊ∫ê‰∏ãËΩΩ
        isLiveError: 'Â§±Ë¥•ÔºåÁõ¥Êí≠ËµÑÊ∫êËß£ÊûêÂ§±Ë¥•',
        isUnkownError: 'Â§±Ë¥•ÔºåÊú™Áü•ÈîôËØØ(ÁÇπÂáªÈáçËØï)',
        finish: 'ÂÆåÊàê'
    }
    // Â∑¶ËæπÊòæÁ§∫ÁöÑÊ∂àÊÅØÊï∞
    let messagesNumber = GM_getValue('messagesNumber', 5)
    const max = 40
    const min = 3

    // Â∑¶‰æßÈÄöÁü•
    const notice = {
        completedQuantity: 0,
        messagelist: []
    }

    const nameAll = {
        userName: 'Áî®Êà∑Âêç',
        userID: 'Áî®Êà∑ID',
        time: 'Êó∂Èó¥',
        geoName: 'ÂÆö‰Ωç',
        region: 'IPÂå∫Âüü',
        text: 'ÂæÆÂçöÊñáÊú¨(Ââç20Â≠ó)',
    }
    let nameArr = GM_getValue('nameArr', ['userName', 'time'])

    // ÈÄíÂΩíproxy
    function reactive(data, callBack) {
        return new Proxy(data, {
            set(target, propKey, value, receiver) {
                callBack && callBack(target, propKey, value, receiver)
                if (typeof value === 'object') {
                    value = reactive(value, callBack)
                }
                return Reflect.set(target, propKey, value, receiver)
            }
        })
    }

    const data = reactive({}, (target, propKey, value, receiver) => {
        const {
            name,
        } = target
        if (propKey === 'message') {
            // Êï∞ÊçÆÂèòÂåñÊõ¥Êñ∞Ê∂àÊÅØ
            retextDom($(`${cardHeadStr}:has(>[href="${name}"])`), value)
            handleMessage(target, value)
        }
    })

    function handleMessage(target, value) {
        const {
            name,
            title,
            percentage
        } = target

        // title‰∏∫Á©∫ÔºåÂç≥Êú™ÂàùÂßãÂåñ
        if (title === '') {
            return false
        }

        const list = [...Object.keys(data)]
        notice.completedQuantity = list.length;
        list.forEach(item => {
            let {
                completedQuantity,
                total,
            } = data[item]

            if (completedQuantity === total) {
                notice.completedQuantity--
            }
        })

        if (config.isShowActive.value) {
            notice.messagelist = notice.messagelist.filter(item => item.message !== '‰∏ãËΩΩÂÆåÊàê')
        }

        notice.messagelist = notice.messagelist.filter(item => item.title !== title).slice(-(messagesNumber - 1))
        notice.messagelist.push({
            href: name,
            title,
            percentage,
            message: `‰∏ãËΩΩ${value}`
        })

        const tempList = JSON.parse(JSON.stringify(notice.messagelist))

        $('#wah0713 .container .showMessage').html(`
            <p><span>ËøõË°å‰∏≠ÁöÑ‰∏ãËΩΩ‰ªªÂä°Êï∞Ôºö</span><span class="red">${notice.completedQuantity}</span></p>
            ${tempList.reverse().map(item=>{
                return `<p><a href="${item.href}" style="background-image: linear-gradient(to right,#333 ${item.percentage}%,#91c6ca 0);" target="_blank" title="ÊâìÂºÄÂæÆÂçöËØ¶ÊÉÖ">${item.title}</a><span>:</span><span data-href=${item.href} class="red downloadBtn" title="ÁÇπÂáªÂÜçÊ¨°‰∏ãËΩΩ">${item.message}</span></p>`
            }).join('')}
        `)

        clearTimeout(timer)
        $('#wah0713').removeClass('out')
        if (config.isAutoHide.value && notice.completedQuantity === 0) {
            timer = setTimeout(() => {
                $('#wah0713').addClass('out')
            }, 5000)
        }
    }

    // Ëé∑ÂèñËµÑÊ∫êÈìæÊé•
    async function getFileUrlByInfo(dom) {
        const id = $(dom).children('a').attr('href').match(/(?<=\d+\/)(\w+)/) && RegExp.$1
        const {
            isLive,
            topMedia,
            pic_infos,
            mix_media_info,
            text_raw,
            isLongText,
            region_name,
            geo,
            created_at,
            mblog_vip_type,
            user: {
                screen_name,
                idstr
            }
        } = await getInfoById(id)

        const date = new Date(created_at)
        const Y = date.getFullYear()
        const M = formatNumber(date.getMonth() + 1)
        const D = formatNumber(date.getDate())
        const H = formatNumber(date.getHours())
        const m = formatNumber(date.getMinutes())
        const time = `${Y}-${M}-${D} ${H}:${m}`

        const urlData = {};

        // ÂõæÁâá
        if (pic_infos) {
            const arr = [...Object.keys(pic_infos)]
            arr.forEach((ele, index) => {
                const afterName = arr.length === 1 ? '' : `-part${formatNumber(index + 1)}`

                // Ë∂ÖÈ´òÊ∏ÖÂõæÊ∫ê
                let url = `https://weibo.com/ajax/common/download?pid=${ele}`
                // È´òÊ∏ÖÂõæÊ∫ê
                const mw2000Url = get(pic_infos[ele], 'mw2000.url', '')

                // Á≤â‰∏ù‰∏ìÂ±û
                if (mblog_vip_type === 1) {
                    url = mw2000Url
                }

                urlData[`${afterName}.${getSuffixName(mw2000Url)}`] = url

                if (pic_infos[ele].type === 'livephoto') {
                    const url = get(pic_infos[ele], 'video', '')
                    urlData[`${afterName}.${getSuffixName(url)}`] = url
                }
            })
        }

        // ÂõæÁâáÂä†ËßÜÈ¢ë
        if (mix_media_info) {
            mix_media_info.items.forEach((ele, index) => {
                const afterName = mix_media_info.items.length === 1 ? '' : `-part${formatNumber(index + 1)}`

                let imgUrl = null
                let mediaUrl = null
                if (ele.type === "video") {
                    imgUrl = get(ele, 'data.pic_info.pic_big.url', '')
                    mediaUrl = get(ele, 'data.media_info.mp4_sd_url', '')
                } else {
                    imgUrl = get(ele, 'data.mw2000.url', '')
                }

                urlData[`${afterName}.${getSuffixName(imgUrl)}`] = `https://weibo.com/ajax/common/download?pid=${imgUrl.match(/([\w]+)(?=\.\w+$)/)&& RegExp.$1}`

                if (mediaUrl) {
                    urlData[`${afterName}.${getSuffixName(mediaUrl)}`] = mediaUrl
                }
            })
        }

        // ËßÜÈ¢ë
        if (topMedia) {
            urlData.media = topMedia
        }

        return {
            isLive,
            urlData,
            time,
            geo,
            isLongText,
            text: text_raw,
            regionName: region_name,
            userName: screen_name,
            userID: idstr,
        }
    }

    // Âà§Êñ≠‰∏∫Á©∫ÂõæÁâá
    function isEmptyFile(res) {
        const size = get(res, '_blob.size', 0)
        const finalUrl = get(res, 'finalUrl', '')
        if (finalUrl.endsWith('gif#101') || size <= 200) {
            return true
        }
        return false
    }

    // Ëé∑ÂèñÂêéÁºÄ
    function getSuffixName(url) {
        let suffixName = new URL(url).pathname.match(/\.(\w+)$/) && RegExp.$1
        if (['json', null].includes(suffixName)) {
            suffixName = 'mp4'
        }
        return suffixName
    }

    // Â§ÑÁêÜÂêçÁß∞
    function getFileName({
        time,
        userName,
        userID,
        regionName,
        geo,
        text,
    }) {

        const region = regionName && regionName.match(/\s(.*)/) && RegExp.$1 || ''
        const geoName = get(geo, 'detail.title', '')
        text = text.slice(0, 20)

        const nameObj = {
            time,
            userName,
            userID,
            region,
            geoName,
            text,
        }

        let title = ''
        for (let i = 0; i < nameArr.length; i++) {
            const item = nameArr[i];
            if (nameObj[item]) {
                title += ` ${nameObj[item]}`
            }
        }
        title = title.trim()
        // ÊõøÊç¢‰∏ãËΩΩÂêç‰∏≠„ÄêÁâπÊÆäÁ¨¶Âè∑„Äë‰∏∫‰∏ãÂàíÁ∫ø„Äê_„Äë
        if (config.isSpecialHandlingName.value) {
            title = title.replace(/[\<|\>|\\|\/|;|:|\*|\?|\$|@|\&|\(|\)|\"|\'|#|\|]/g, '_')
        }
        return title
    }

    // ÊâìÂåÖ
    function pack(resBlob, modification) {
        const zip = new JSZip();
        resBlob.forEach(function (obj) {
            const name = `${modification}${obj._lastName}`
            zip.file(name, obj._blob);
        });
        return new Promise(async (resolve, reject) => {
            // ÁîüÊàêzipÊñá‰ª∂Âπ∂‰∏ãËΩΩ
            resolve(await zip.generateAsync({
                type: 'blob'
            }))
        })
    }

    // Ê®°ÊãüÁÇπÂáª‰∏ãËΩΩ
    function download(url, fileName) {
        const a = document.createElement('a')
        a.setAttribute('href', url)
        a.setAttribute('download', fileName)
        a.click()
        a.remove()
        // ÈáäÊîæURL
        URL.revokeObjectURL(url)
    }

    // ‰∏ãËΩΩÊµÅÔºàÊñáÊú¨Ôºâ
    async function getTextBlob({
        text,
        href,
        isLongText
    }) {
        let content = text;
        if (isLongText) {
            content = await getLongtextById(href.match(/(?<=\d+\/)(\w+)/) && RegExp.$1) || text
        }

        const _blob = new Blob([content], {
            type: "text/plain;charset=utf-8",
        });

        return {
            _blob,
            _lastName: '.txt',
            finalUrl: 'https://github.com/wah0713/text.txt'
        }
    }

    // ‰∏ãËΩΩÊµÅ
    function getFileBlob(url, _lastName, options) {
        return new Promise((resolve, reject) => {
            GM_xmlhttpRequest({
                url,
                method: 'get',
                responseType: 'blob',
                headers: {
                    referer: 'https://weibo.com/',
                    'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/106.0.0.0 Safari/537.36'
                },
                onload: (res) => {
                    isDebug && console.log(`getFileBlob-onload`, res)
                    options.callback && options.callback()

                    // ‰∏ãËΩΩÂ§±Ë¥•Ôºå‰πü‰ºöÊ≠£Â∏∏ËøîÂõûÁ©∫Êñá‰ª∂
                    const {
                        size,
                        type
                    } = res.response;
                    if (size <= 200 && type === "text/html; charset=utf-8") {
                        resolve(null)
                    }

                    resolve({
                        ...res,
                        _blob: res.response,
                        _lastName
                    })
                },
                onerror: (res) => {
                    console.error(`getFileBlob-onerror`, res)
                    resolve(null)
                },
                onprogress: (res) => {
                    options.onprogress && options.onprogress(res)
                }
            })
        })
    }

    // ÈÄöËøáidËé∑ÂèñÈìæÊé•
    function getInfoById(id) {
        return new Promise((resolve, reject) => {
            GM_xmlhttpRequest({
                url: `https://weibo.com/ajax/statuses/show?id=${id}`,
                responseType: 'json',
                onload: (res) => {
                    isDebug && console.log(`getInfoById-onload`, res)
                    const response = res.response
                    response.topMedia = ''

                    try {
                        // retweeted_status ‰∏∫ËΩ¨Âèë
                        if (res.response.retweeted_status) {
                            response.pic_infos = res.response.retweeted_status.pic_infos
                            response.mix_media_info = res.response.retweeted_status.mix_media_info
                        }

                        // ËßÜÈ¢ë
                        if (res.response.page_info) {
                            const {
                                isLive,
                                url
                            } = handleMedia(res)

                            response.topMedia = url
                            // Áõ¥Êí≠ËµÑÊ∫ê
                            response.isLive = isLive
                        }
                    } catch (error) {}
                    resolve(response)
                },
                onerror: (res) => {
                    console.error(`getInfoById-onerror`, res)
                    resolve(null)
                }
            })
        })
    }

    // ËßÜÈ¢ëËµÑÊ∫êËß£Êûê
    function handleMedia(res) {
        const objectType = get(res.response, 'page_info.object_type', '')
        const url = get(res.response, 'page_info.media_info.playback_list[0].play_info.url', get(res.response, 'page_info.media_info.stream_url', ''))
        return {
            isLive: objectType === 'live',
            url
        }
    }

    function blobToText(blob) {
        return new Promise((resolve, reject) => {
            // Â∞ÜblobËΩ¨‰∏∫text
            let reader = new FileReader()
            reader.readAsText(blob, "utf-8")
            reader.addEventListener("loadend", () => {
                // textÊ†ºÂºè
                resolve(reader.result)
            })
        })
    }

    // ÈÄöËøáidËé∑ÂèñÈïøÊñá
    function getLongtextById(id) {
        return new Promise((resolve, reject) => {
            GM_xmlhttpRequest({
                url: `https://weibo.com/ajax/statuses/longtext?id=${id}`,
                responseType: 'json',
                onload: (res) => {
                    isDebug && console.log(`getLongtextById-onload`, res)
                    const response = res.response
                    resolve(response.data.longTextContent)
                },
                onerror: (res) => {
                    console.error(`getLongtextById-onerror`, res)
                    resolve(null)
                }
            })
        })
    }

    // ‰ΩúËÄÖÔºö Ê≤êÁßãAlron
    // ÈìæÊé•Ôºö https://juejin.cn/post/7099344493010223134
    class TaskQueue {
        constructor(num = 10) {
            this.originMax = num; // ÂéüÂßãÊúÄÂ§ßÂπ∂ÂèëÊï∞
            this.max = this.originMax; // ÊúÄÂ§ßÂπ∂ÂèëÊï∞
            this.index = 0 // ‰∏ãÊ†á
            this.taskList = [] // Áî®shiftÊñπÊ≥ïÂÆûÁé∞ÂÖàËøõÂÖàÂá∫
            this.resList = [] // ÊúÄÂêéËøîÂõûÈòüÂàóÊï∞ÁªÑ
            this.isError = false // ‰ªªÂä°Â§±Ë¥•
        }

        addTask(task) {
            this.taskList.push({
                task,
                index: this.index++
            });
        }

        async start() {
            return await this.run()
        }

        run() {
            return new Promise((resolve, reject) => {
                const length = this.taskList.length;
                if (!length) {
                    return false;
                }
                // ÊéßÂà∂Âπ∂ÂèëÊï∞Èáè
                const min = Math.min(length, this.max);
                for (let i = 0; i < min; i++) {
                    // ÂºÄÂßãÂç†Áî®‰∏Ä‰∏™‰ªªÂä°ÁöÑÁ©∫Èó¥
                    this.max--;
                    const {
                        task,
                        index
                    } = this.taskList.shift();

                    task.then((res) => {
                        if (res === null) {
                            // ‰ªªÊÑè‰∏Ä‰∏™Â§±Ë¥•
                            this.isError = true
                            resolve(false)
                        }
                        this.resList[index] = res
                    }).finally(async () => {
                        // ‰ªªÂä°ÂÆåÊàêÔºåÈáäÊîæÁ©∫Èó¥
                        this.max++;

                        if (this.isError) return false

                        if (this.max === this.originMax) {
                            // ‰ªªÂä°ÂÆåÊàê
                            resolve(this.resList)
                        }
                        // Ëá™Âä®ËøõË°å‰∏ã‰∏Ä‰∏™‰ªªÂä°
                        resolve(await this.run())
                    })
                }
            })
        }
    }

    // ‰∏ãËΩΩËßÜÈ¢ë
    async function DownLoadMedia({
        href,
        urlData,
        text,
        isLongText
    }) {
        const mediaRes = await getFileBlob(urlData.media, `.${getSuffixName(urlData.media)}`, {
            onprogress: (res) => {
                const {
                    loaded,
                    totalSize
                } = res
                const completedQuantity = loaded
                const total = totalSize
                data[href].completedQuantity = completedQuantity
                data[href].total = total
                const percentage = completedQuantity / total * 100

                data[href].percentage = percentage
                data[href].message = `‰∏≠${formatNumber(completedQuantity / 1024/ 1024)}/${formatNumber(total / 1024/ 1024)}MÔºà${formatNumber(percentage)}%Ôºâ`
            }
        })
        if (!get(mediaRes, '_blob', null)) {
            return false
        }

        if (!get(mediaRes, '_blob.type', '').startsWith('video')) {
            const parser = new m3u8Parser.Parser();
            parser.push(await blobToText(mediaRes._blob));
            parser.end();

            const urlArr = parser.manifest.segments.map(item => {
                let url
                try {
                    new URL(item.uri)
                    url = item.uri
                } catch (error) {
                    url = `${new URL(urlData.media).origin}/${item.uri}`
                }
                return url
            });

            data[href].completedQuantity = 0
            const total = urlArr.length

            const taskQueue = new TaskQueue();
            urlArr.forEach(item =>
                taskQueue.addTask(getFileBlob(item, '', {
                    callback: () => {
                        data[href].completedQuantity++
                        const completedQuantity = data[href].completedQuantity

                        const percentage = new Intl.NumberFormat(undefined, {
                            maximumFractionDigits: 2
                        }).format(completedQuantity / total * 100)

                        data[href].percentage = percentage
                        data[href].message = `‰∏≠${completedQuantity}/${total}Ôºà${percentage}%Ôºâ`
                    }
                }))
            )

            const taskQueueRes = await taskQueue.start()
            if (taskQueueRes === false) {
                // Ëß£ÊûêÂ§±Ë¥•
                return false
            }

            mediaRes._blob = new Blob(taskQueueRes.map(item => item._blob), {
                type: 'video/MP2T'
            })
            mediaRes._lastName = '.mp4'
        }

        if (text) {
            const content = await pack([mediaRes, await getTextBlob({
                text,
                href,
                isLongText
            })], data[href].title)

            download(URL.createObjectURL(content), `${data[href].title}.zip`)
        } else {
            download(URL.createObjectURL(mediaRes._blob), `${data[href].title}${mediaRes._lastName}`)
        }
        return true
    }

    // ‰∏ãËΩΩÔºàÈªòËÆ§Ôºâ
    async function DownLoadDefault({
        href,
        urlData,
        urlArr,
        text = '',
        isLongText
    }) {
        const total = urlArr.length
        data[href].total = total

        const taskQueue = new TaskQueue(3);
        urlArr.forEach(item =>
            taskQueue.addTask(getFileBlob(urlData[item], item, {
                callback: () => {
                    data[href].completedQuantity++
                    const completedQuantity = data[href].completedQuantity

                    const percentage = new Intl.NumberFormat(undefined, {
                        maximumFractionDigits: 2
                    }).format(completedQuantity / total * 100)

                    data[href].percentage = percentage
                    data[href].message = `‰∏≠${completedQuantity}/${total}Ôºà${percentage}%Ôºâ`
                }
            }))
        )

        let taskQueueRes = await taskQueue.start()
        if (taskQueueRes === false) {
            // Ëß£ÊûêÂ§±Ë¥•
            return false
        }

        if (text) {
            taskQueueRes.push(await getTextBlob({
                text,
                href,
                isLongText
            }))
        }

        taskQueueRes = taskQueueRes.filter(item => !isEmptyFile(item));

        if (taskQueueRes.length === 0) {
            return null
        } else if (taskQueueRes.length === 1) {
            download(URL.createObjectURL(taskQueueRes[0]._blob), `${data[href].title}${taskQueueRes[0]._lastName}`)
        } else if (taskQueueRes.length > 1) {
            const content = await pack(taskQueueRes, data[href].title)
            download(URL.createObjectURL(content), `${data[href].title}.zip`)
        }
        return true
    }

    // Êï∞Â≠óÊ†ºÂºèÂåñ
    function formatNumber(number) {
        return String(new Intl.NumberFormat(undefined, {
            maximumFractionDigits: 2
        }).format(number)).padStart(2, '0')
    }

    // dom‰øÆÊîπÊñáÊú¨
    function retextDom(dom, text) {
        $(dom).attr('show-text', text)
    }

    /**
     * object: ÂØπË±°
     * path: ËæìÂÖ•ÁöÑË∑ØÂæÑ
     * defaultVal: ÈªòËÆ§ÂÄº
     * url: https://blog.csdn.net/RedaTao/article/details/108119230
     **/
    function get(object, path, defaultVal = undefined) {
        // ÂÖàÂ∞ÜpathÂ§ÑÁêÜÊàêÁªü‰∏ÄÊ†ºÂºè
        let newPath = [];
        if (Array.isArray(path)) {
            newPath = path;
        } else {
            // ÂÖàÂ∞ÜÂ≠óÁ¨¶‰∏≤‰∏≠ÁöÑ'['„ÄÅ']'ÂéªÈô§ÊõøÊç¢‰∏∫'.'ÔºåsplitÂàÜÂâ≤ÊàêÊï∞ÁªÑÂΩ¢Âºè
            newPath = path.replace(/\[/g, '.').replace(/\]/g, '').split('.');
        }

        // ÈÄíÂΩíÂ§ÑÁêÜÔºåËøîÂõûÊúÄÂêéÁªìÊûú
        return newPath.reduce((o, k) => {
            return (o || {})[k]
        }, object) || defaultVal;
    }

    async function main({
        href,
        urlData,
        text,
        isLongText
    }) {

        if (data[href].isLive) {
            data[href].message = message.isLiveError
            return false
        }

        const urlArr = Object.keys(urlData);
        if (urlArr.length <= 0) {
            // Ê≤°ÊúâËµÑÊ∫ê
            data[href].message = message.isEmptyError
            return false
        }

        let isSuccess = true

        if (!config.isIncludesText.value) {
            text = ''
        }

        if (urlArr.length === 1 && urlArr[0] === 'media') {
            // ‰∏ãËΩΩËßÜÈ¢ë
            isSuccess = await DownLoadMedia({
                href,
                urlData,
                text,
                isLongText
            })
        } else {
            // ‰∏ãËΩΩÔºàÈªòËÆ§Ôºâ
            isSuccess = await DownLoadDefault({
                href,
                urlData,
                urlArr,
                text,
                isLongText
            })
        }

        if (isSuccess === null) {
            // Ê≤°ÊúâËµÑÊ∫ê
            data[href].message = message.isEmptyError
        } else if (isSuccess) {
            // ‰∏ãËΩΩÊàêÂäü
            data[href].message = message.finish
        } else {
            // ‰∏ãËΩΩÂ§±Ë¥•
            data[href].message = message.isUnkownError
        }
    }

    // Ê®°Êãüesc
    function clickEscKey() {
        const evt = document.createEvent('UIEvents');
        Object.defineProperty(evt, 'keyCode', {
            get: function () {
                return this.keyCodeVal;
            }
        });
        Object.defineProperty(evt, 'which', {
            get: function () {
                return this.keyCodeVal;
            }
        });
        evt.keyCodeVal = 27;
        evt.initEvent('keydown', true, true);
        document.body.dispatchEvent(evt);
    }
    // È¢ÑËßàÂõæÁâáÊó∂ÔºåÁÇπÂáªÂõæÁâáÂÖ≥Èó≠È¢ÑËßàÂäüËÉΩ
    $('.imgInstance.Viewer_imgElm_2JHWe').on('click', clickEscKey)

    $main.prepend(`
    <div id="wah0713">
        <div class="container">
            <div class="showMessage"></div>
            <div class="editName">
                <span>ÂèØÈÄâ‰∏ãËΩΩÂêçÔºà„ÄêÁÇπÂáª„ÄëÊàñ„ÄêÊãñÊãΩÂà∞‰∏ãÊñπ„ÄëÔºâ</span>
                <ul class="unactive">
                    ${[...Object.keys(nameAll)].filter(item=>!nameArr.includes(item)).map(item=>{
                        return `<li data-id="${item}" draggable="true">${nameAll[item]}</li>`
                    }).join('')}
                </ul>
                <span>ÂΩìÂâç‰∏ãËΩΩÂêçÔºà„ÄêÁî®Êà∑Âêç„Äë‰∏∫ÂøÖÈÄâÔºâ</span>
                <ul class="active">
                    ${nameArr.map(item=>{
                        return `<li data-id="${item}" draggable="true">${nameAll[item]}</li>`
                    }).join('')}
                </ul>
            </div>
            <div class="input-box">ÈúÄË¶ÅÊòæÁ§∫ÁöÑÊ∂àÊÅØÊù°Êï∞Ôºö<input type="number" max="${max}" min="${min}" value="${messagesNumber}"
                    step=1>
            </div>
        </div>
    </div>
       `)

    let dragstartDom = null;

    function updateNameArr() {
        nameArr = []
        dragstartDom = null;
        [...document.querySelector(`#wah0713 .editName ul.active`).children].forEach(item => {
            nameArr.push(item.dataset.id)
        })
        GM_setValue('nameArr', nameArr)
    }

    [...document.querySelectorAll('#wah0713 .editName ul')].forEach(item => {

        item.addEventListener('dragstart', function (event) {
            if (event.target.nodeName !== 'LI') {
                return false
            }
            dragstartDom = event.target
        });

        item.addEventListener('dragleave', function (event) {
            event.target.classList.remove('outline')
        });

        item.addEventListener('dragover', function (event) {
            if (item.classList.contains('unactive') && dragstartDom.dataset.id === 'userName') {
                event.dataTransfer.dropEffect = 'none';
                return false
            }
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            event.target.classList.add('outline')
        });

        item.addEventListener('drop', function (event) {
            event.target.classList.remove('outline')
            if (event.target.nodeName === 'LI') {
                event.target.insertAdjacentElement("beforeBegin", dragstartDom)
            } else if (event.target.nodeName === 'UL') {
                event.target.insertAdjacentElement("beforeEnd", dragstartDom)
            }
            updateNameArr()
        });

        item.addEventListener('click', function (event) {
            if (event.target.nodeName !== 'LI' || event.target.dataset.id === 'userName') {
                return false
            }
            const className = item.classList.contains('unactive') ? 'active' : 'unactive'
            document.querySelector(`#wah0713 .editName ul.${className}`).insertAdjacentElement("beforeEnd", event.target)
            updateNameArr()
        })
    })

    // ÊòØÁ¨¨‰∏ÄÊ¨°‰ΩøÁî®ÂºÄÂêØ
    if (isFirst) {
        $cardList.addClass('isFirst')
    }

    $cardList.on('click', `${cardHeadStr}:not(.Feed_retweetHeadInfo_Tl4Ld)`, async function (event) {
        if (event.target.className !== event.currentTarget.className || ![...Object.values(message).filter(item => item !== message.getReady), undefined, ''].includes(
                $(this).attr('show-text')
            )) return false

        // ÂÖ≥Èó≠Á¨¨‰∏ÄÊ¨°‰ΩøÁî®ÊèêÁ§∫
        if (isFirst) {
            isFirst = false
            GM_setValue('isFirst', false)
            $cardList.removeClass('isFirst')
        }

        const href = $(this).find(cardHeadAStr).attr('href')

        data[href] = {
            urlData: {},
            text: '',
            title: '',
            message: '',
            isLive: false, // Áõ¥Êí≠ËµÑÊ∫ê
            isLongText: false,
            name: href,
            total: 0,
            completedQuantity: 0,
            percentage: 0
        }

        const {
            urlData,
            isLive,
            time,
            userName,
            userID,
            regionName,
            geo,
            text,
            isLongText,
        } = await getFileUrlByInfo(this)

        data[href].title = getFileName({
            time,
            userName,
            userID,
            regionName,
            geo,
            text
        })
        data[href].urlData = urlData
        data[href].text = text
        data[href].isLongText = isLongText
        data[href].message = message.getReady
        data[href].isLive = isLive

        main({
            href,
            urlData,
            text,
            isLongText
        })
    })

    $('.showMessage').on('click', '.downloadBtn', async function (event) {
        if (event.target.className !== event.currentTarget.className || ![...Object.values(message).filter(item => item !== message.getReady), undefined, ''].includes($(this).text().replace(/^‰∏ãËΩΩ/, ''))) return false
        const href = $(this).data('href')

        data[href].completedQuantity = 0
        data[href].message = message.getReady

        main({
            href,
            urlData: data[href].urlData,
            text: data[href].text,
            isLongText: data[href].isLongText,
        })
    })

    $('#wah0713 .container .input-box input').change(event => {
        event.target.value = event.target.value | 0
        if (event.target.value > max) {
            event.target.value = max
        }
        if (event.target.value < min) {
            event.target.value = min
        }
        messagesNumber = event.target.value
        GM_setValue('messagesNumber', messagesNumber)
    })

    const observer = new MutationObserver(() => {
        $(cardHeadStr).attr('show-text', '');
        requestAnimationFrame(() => {
            [...Object.keys(data)].forEach(item => {
                const {
                    message,
                } = data[item]
                retextDom($(`${cardHeadStr}:has(>[href="${item}"])`), message)
            })
        })
    });
    observer.observe($main[0], {
        childList: true,
        subtree: true
    });

    const config = {
        isSpecialHandlingName: {
            name: 'ÊõøÊç¢‰∏ãËΩΩÂêç‰∏≠„ÄêÁâπÊÆäÁ¨¶Âè∑„Äë‰∏∫‰∏ãÂàíÁ∫ø„Äê_„Äë',
            id: null,
            value: GM_getValue('isSpecialHandlingName', false)
        },
        isAutoHide: {
            name: 'Â∑¶‰æßÊ∂àÊÅØËá™Âä®Ê∂àÂ§±',
            id: null,
            value: GM_getValue('isAutoHide', false)
        },
        isShowActive: {
            name: 'Â∑¶‰æßÊ∂àÊÅØËøáÊª§„ÄêÂ∑≤ÁªèÂÆåÊàê„Äë',
            id: null,
            value: GM_getValue('isShowActive', false)
        },
        isIncludesText: {
            name: '‰∏ãËΩΩÊñá‰ª∂‰∏≠ÂåÖÂê´„ÄêÂæÆÂçöÊñáÊú¨„Äë',
            id: null,
            value: GM_getValue('isIncludesText', false)
        }
    }

    function updateMenuCommand() {
        [...Object.keys(config)].forEach(item => {
            const {
                id,
                value,
                name
            } = config[item]
            if (id) {
                GM_unregisterMenuCommand(id)
            }
            config[item].id = GM_registerMenuCommand(`${value?'‚úîÔ∏è':'‚ùå'}${name}`, () => {
                GM_setValue(item, !value)
                config[item].value = !value
                updateMenuCommand()
            })
        })
    }
    updateMenuCommand()

    GM_addStyle(`body {
  --yellow: #ff8200;
  --red: #ff3852;
}
div.card-feed div.from::after,
.head-info_info_2AspQ:not(.Feed_retweetHeadInfo_Tl4Ld)::after {
  content: "‰∏ãËΩΩ" attr(show-text);
  color: var(--yellow);
  cursor: pointer;
  float: right;
}
.Main_full_1dfQX.isFirst .head-info_info_2AspQ:not(.Feed_retweetHeadInfo_Tl4Ld)::after,
.main-full.isFirst div.card-feed div.from::after {
  animation: wobble infinite 1s alternate;
}
@keyframes wobble {
  from {
    -webkit-transform: translate3d(0, 0, 0);
    transform: translate3d(0, 0, 0);
  }
  15% {
    -webkit-transform: translate3d(-25%, 0, 0) rotate3d(0, 0, 1, -5deg);
    transform: translate3d(-25%, 0, 0) rotate3d(0, 0, 1, -5deg);
  }
  30% {
    -webkit-transform: translate3d(20%, 0, 0) rotate3d(0, 0, 1, 3deg);
    transform: translate3d(20%, 0, 0) rotate3d(0, 0, 1, 3deg);
  }
  45% {
    -webkit-transform: translate3d(-15%, 0, 0) rotate3d(0, 0, 1, -3deg);
    transform: translate3d(-15%, 0, 0) rotate3d(0, 0, 1, -3deg);
  }
  60% {
    -webkit-transform: translate3d(10%, 0, 0) rotate3d(0, 0, 1, 2deg);
    transform: translate3d(10%, 0, 0) rotate3d(0, 0, 1, 2deg);
  }
  75% {
    -webkit-transform: translate3d(-5%, 0, 0) rotate3d(0, 0, 1, -1deg);
    transform: translate3d(-5%, 0, 0) rotate3d(0, 0, 1, -1deg);
  }
  to {
    -webkit-transform: translate3d(0, 0, 0);
    transform: translate3d(0, 0, 0);
  }
}
.m-main #wah0713,
.Frame_content_3XrxZ #wah0713 {
  font-size: 12px;
  font-weight: bold;
}
.m-main #wah0713.out,
.Frame_content_3XrxZ #wah0713.out {
  opacity: 0;
}
.m-main #wah0713.out:hover,
.Frame_content_3XrxZ #wah0713.out:hover {
  opacity: 1;
}
.m-main #wah0713 .container,
.Frame_content_3XrxZ #wah0713 .container {
  position: fixed;
  left: 0;
  z-index: 1;
}
.m-main #wah0713:hover .input-box,
.Frame_content_3XrxZ #wah0713:hover .input-box,
.m-main #wah0713:hover .editName,
.Frame_content_3XrxZ #wah0713:hover .editName {
  display: block;
}
.m-main #wah0713 input,
.Frame_content_3XrxZ #wah0713 input {
  width: 3em;
  color: var(--yellow);
  border-width: 1px;
  outline: 0;
  background-color: transparent;
}
.m-main #wah0713 .input-box,
.Frame_content_3XrxZ #wah0713 .input-box {
  display: none;
}
.m-main #wah0713 .showMessage > p,
.Frame_content_3XrxZ #wah0713 .showMessage > p {
  line-height: 16px;
  margin: 4px;
}
.m-main #wah0713 .showMessage > p span,
.Frame_content_3XrxZ #wah0713 .showMessage > p span {
  color: #333;
  vertical-align: top;
}
.m-main #wah0713 .showMessage > p span.red,
.Frame_content_3XrxZ #wah0713 .showMessage > p span.red {
  color: var(--yellow);
}
.m-main #wah0713 .showMessage > p span.red.downloadBtn,
.Frame_content_3XrxZ #wah0713 .showMessage > p span.red.downloadBtn {
  cursor: pointer;
}
.m-main #wah0713 .showMessage > p a,
.Frame_content_3XrxZ #wah0713 .showMessage > p a {
  color: transparent;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 300px;
  display: inline-block;
  white-space: nowrap;
  -webkit-background-clip: text;
}
.m-main #wah0713 .showMessage > p a:hover,
.Frame_content_3XrxZ #wah0713 .showMessage > p a:hover {
  text-decoration: none;
}
.m-main #wah0713 .editName,
.Frame_content_3XrxZ #wah0713 .editName {
  display: none;
  border: 1px solid #ccc;
  padding: 2px;
  border-radius: 6px;
  user-select: none;
}
.m-main #wah0713 .editName ul,
.Frame_content_3XrxZ #wah0713 .editName ul {
  list-style: none;
  display: flex;
  height: 20px;
  margin: 0;
  padding: 0 10px 0 0;
  background-color: #fafafa;
}
.m-main #wah0713 .editName li,
.Frame_content_3XrxZ #wah0713 .editName li {
  height: 20px;
  line-height: 20px;
  background: var(--red);
  color: #fff;
  padding-inline: 3px;
  margin-left: 2px;
  font-size: 12px;
  cursor: grab;
  border-radius: 5px;
}
.m-main #wah0713 .unactive li,
.Frame_content_3XrxZ #wah0713 .unactive li {
  background: var(--yellow);
}
.m-main #wah0713 .outline,
.Frame_content_3XrxZ #wah0713 .outline {
  outline: 2px solid #119da6;
}
`)

    // // debugJS
    // isDebug = true
    // unsafeWindow.$ = $
})()